#!/usr/bin/env python3
import json, subprocess, sys
from pathlib import Path

class C:
    B='\033[1m'; G='\033[92m'; Y='\033[93m'; R='\033[91m'; C='\033[96m'; E='\033[0m'

class ProxyManager:
    def __init__(self):
        config_home = Path.home() / '.config' / 'secure-tools'
        config_home.mkdir(parents=True, exist_ok=True)
        self.config_file = config_home / 'proxy-profiles.json'
        self.current_file = config_home / 'current-proxy-profile'
        self._ensure_config()
    
    def _ensure_config(self):
        if not self.config_file.exists():
            self._save({'profiles': {'work': {'http': '', 'https': '', 'ignore': ['localhost', '127.0.0.1', '::1']}}})
    
    def _load(self):
        return json.load(open(self.config_file))
    
    def _save(self, config):
        with open(self.config_file, 'w') as f:
            json.dump(config, f, indent=2)
        self.config_file.chmod(0o600)
    
    def _gs(self, key, val):
        subprocess.run(['gsettings', 'set', 'org.gnome.system.proxy', key, str(val)], check=True, capture_output=True)
    
    def _gg(self, key):
        return subprocess.run(['gsettings', 'get', 'org.gnome.system.proxy', key], 
                            capture_output=True, text=True, check=True).stdout.strip().strip("'")
    
    def set_off(self):
        self._gs('mode', "'none'")
        for k in ['http.host', 'https.host']: self._gs(k, "''")
        for k in ['http.port', 'https.port']: self._gs(k, '0')
        self._gs('ignore-hosts', "[]")
        self.current_file.write_text('off')
        print(f"{C.G}✓ Proxy disabled{C.E}")
    
    def set_profile(self, name):
        config = self._load()
        if name not in config['profiles']:
            print(f"{C.R}Profile '{name}' not found{C.E}"); sys.exit(1)
        p = config['profiles'][name]
        self._gs('mode', "'manual'")
        if p.get('http'):
            h, pt = p['http'].split(':')
            self._gs('http.host', f"'{h}'")
            self._gs('http.port', pt)
        if p.get('https'):
            h, pt = p['https'].split(':')
            self._gs('https.host', f"'{h}'")
            self._gs('https.port', pt)
        self._gs('ignore-hosts', json.dumps(p.get('ignore', [])))
        self.current_file.write_text(name)
        print(f"{C.G}✓ Proxy set to '{name}'{C.E}")
    
    def status(self):
        mode = self._gg('mode')
        print(f"\n{C.B}Proxy:{C.E} {mode}")
        if mode == 'manual':
            prof = self.current_file.read_text().strip() if self.current_file.exists() else 'unknown'
            print(f"{C.B}Profile:{C.E} {C.C}{prof}{C.E}")
            http_h, http_p = self._gg('http.host'), self._gg('http.port')
            https_h, https_p = self._gg('https.host'), self._gg('https.port')
            if http_h: print(f"{C.B}HTTP:{C.E}  {http_h}:{http_p}")
            if https_h: print(f"{C.B}HTTPS:{C.E} {https_h}:{https_p}")
            print(f"{C.B}Ignore:{C.E} {self._gg('ignore-hosts')}")
        print()
    
    def list_profiles(self):
        print(f"\n{C.B}Profiles:{C.E}\n" + "─"*60)
        for name, p in self._load()['profiles'].items():
            print(f"\n{C.C}{name}{C.E}")
            if p.get('http'): print(f"  HTTP:  {p['http']}")
            if p.get('https'): print(f"  HTTPS: {p['https']}")
            if p.get('ignore'): print(f"  Ignore: {', '.join(p['ignore'])}")
        print()
    
    def add_profile(self, name, http, https, ignore):
        config = self._load()
        config['profiles'][name] = {
            'http': http, 'https': https,
            'ignore': [h.strip() for h in ignore.split(',')] if ignore else []
        }
        self._save(config)
        print(f"{C.G}✓ Profile '{name}' saved{C.E}")
    
    def remove_profile(self, name):
        config = self._load()
        if name not in config['profiles']:
            print(f"{C.R}Profile '{name}' not found{C.E}"); sys.exit(1)
        del config['profiles'][name]
        self._save(config)
        print(f"{C.G}✓ Profile '{name}' removed{C.E}")

def main():
    import argparse
    p = argparse.ArgumentParser(description='GNOME Proxy Manager')
    p.add_argument('profile', nargs='?', help='Profile name or "off"')
    p.add_argument('--list', '-l', action='store_true', help='List profiles')
    p.add_argument('--add', '-a', metavar='NAME', help='Add profile')
    p.add_argument('--remove', '-r', metavar='NAME', help='Remove profile')
    p.add_argument('--http', '-H', help='HTTP proxy')
    p.add_argument('--https', '-S', help='HTTPS proxy')
    p.add_argument('--ignore', '-i', help='Ignored hosts')
    args = p.parse_args()
    
    mgr = ProxyManager()
    try:
        if args.list: mgr.list_profiles()
        elif args.add:
            if not (args.http or args.https):
                print(f"{C.R}Need --http or --https{C.E}"); sys.exit(1)
            mgr.add_profile(args.add, args.http or '', args.https or '', args.ignore or '')
        elif args.remove: mgr.remove_profile(args.remove)
        elif args.profile:
            mgr.set_off() if args.profile == 'off' else mgr.set_profile(args.profile)
        else: mgr.status()
    except (subprocess.CalledProcessError, KeyboardInterrupt):
        print(f"\n{C.Y}Cancelled{C.E}"); sys.exit(1)

if __name__ == '__main__':
    main()
